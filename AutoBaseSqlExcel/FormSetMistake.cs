using System;
using System.Drawing;
using System.Collections;
using System.ComponentModel;
using System.Windows.Forms;

namespace AutoBaseSql
{
	/// <summary>
	/// Summary description for FormSetMistake.
	/// </summary>
	public class FormSetMistake : System.Windows.Forms.Form
	{
		private System.Windows.Forms.TextBox textBox_guaranty;
		private System.Windows.Forms.Button button_select_guaranty;
		private System.Windows.Forms.Label label1;
		private System.Windows.Forms.Label label2;
		private System.Windows.Forms.TextBox textBox_mistake_initiator;
		private System.Windows.Forms.Button button_select_mistake_initiator;
		private System.Windows.Forms.TextBox textBox_mistake;
		private System.Windows.Forms.Button button_ok;
		private System.Windows.Forms.Button button_remove_mistake_initiator;
		/// <summary>
		/// Required designer variable.
		/// </summary>
		private System.ComponentModel.Container components = null;

		DtCardDetail	card_detail			= null;
		DtCardWork		card_work			= null;
		DbStaff			mistake_initiator	= null;
		DbGuarantyType	guaranty_type		= null;
		string			mistake_text		= "";
		int				the_type;

		public FormSetMistake(DtCard card, long position, int type)
		{
			//
			// Required for Windows Form Designer support
			//
			InitializeComponent();

			the_type	= type;
			switch(type)
			{
				case 0:
					InitDetail(card, position);
					break;
				case 1:
					InitWork(card, position);
					break;
				default:
					button_ok.Enabled = false;
					break;
			}
			// Отображение
			if(mistake_initiator != null)
				textBox_mistake_initiator.Text	= mistake_initiator.Title;
			else
				textBox_mistake_initiator.Text	= "Не установлен";

			if(guaranty_type != null)
				textBox_guaranty.Text	= guaranty_type.Description;
			else
				textBox_guaranty.Text	= "Не установлен";

			textBox_mistake.Text		= mistake_text;
		}

		/// <summary>
		/// Clean up any resources being used.
		/// </summary>
		protected override void Dispose( bool disposing )
		{
			if( disposing )
			{
				if(components != null)
				{
					components.Dispose();
				}
			}
			base.Dispose( disposing );
		}

		#region Windows Form Designer generated code
		/// <summary>
		/// Required method for Designer support - do not modify
		/// the contents of this method with the code editor.
		/// </summary>
		private void InitializeComponent()
		{
			this.textBox_guaranty = new System.Windows.Forms.TextBox();
			this.button_select_guaranty = new System.Windows.Forms.Button();
			this.label1 = new System.Windows.Forms.Label();
			this.label2 = new System.Windows.Forms.Label();
			this.textBox_mistake_initiator = new System.Windows.Forms.TextBox();
			this.button_select_mistake_initiator = new System.Windows.Forms.Button();
			this.textBox_mistake = new System.Windows.Forms.TextBox();
			this.button_ok = new System.Windows.Forms.Button();
			this.button_remove_mistake_initiator = new System.Windows.Forms.Button();
			this.SuspendLayout();
			// 
			// textBox_guaranty
			// 
			this.textBox_guaranty.BorderStyle = System.Windows.Forms.BorderStyle.FixedSingle;
			this.textBox_guaranty.Enabled = false;
			this.textBox_guaranty.Location = new System.Drawing.Point(8, 32);
			this.textBox_guaranty.Name = "textBox_guaranty";
			this.textBox_guaranty.Size = new System.Drawing.Size(408, 23);
			this.textBox_guaranty.TabIndex = 0;
			this.textBox_guaranty.Text = "";
			// 
			// button_select_guaranty
			// 
			this.button_select_guaranty.Location = new System.Drawing.Point(416, 32);
			this.button_select_guaranty.Name = "button_select_guaranty";
			this.button_select_guaranty.Size = new System.Drawing.Size(24, 23);
			this.button_select_guaranty.TabIndex = 1;
			this.button_select_guaranty.Text = "...";
			this.button_select_guaranty.Click += new System.EventHandler(this.button_select_guaranty_Click);
			// 
			// label1
			// 
			this.label1.Location = new System.Drawing.Point(8, 8);
			this.label1.Name = "label1";
			this.label1.TabIndex = 2;
			this.label1.Text = "Вид гарантии";
			// 
			// label2
			// 
			this.label2.Location = new System.Drawing.Point(8, 64);
			this.label2.Name = "label2";
			this.label2.TabIndex = 3;
			this.label2.Text = "Виновник";
			// 
			// textBox_mistake_initiator
			// 
			this.textBox_mistake_initiator.BorderStyle = System.Windows.Forms.BorderStyle.FixedSingle;
			this.textBox_mistake_initiator.Enabled = false;
			this.textBox_mistake_initiator.Location = new System.Drawing.Point(8, 88);
			this.textBox_mistake_initiator.Name = "textBox_mistake_initiator";
			this.textBox_mistake_initiator.Size = new System.Drawing.Size(408, 23);
			this.textBox_mistake_initiator.TabIndex = 4;
			this.textBox_mistake_initiator.Text = "";
			// 
			// button_select_mistake_initiator
			// 
			this.button_select_mistake_initiator.Location = new System.Drawing.Point(416, 88);
			this.button_select_mistake_initiator.Name = "button_select_mistake_initiator";
			this.button_select_mistake_initiator.Size = new System.Drawing.Size(24, 23);
			this.button_select_mistake_initiator.TabIndex = 5;
			this.button_select_mistake_initiator.Text = "...";
			this.button_select_mistake_initiator.Click += new System.EventHandler(this.button_select_mistake_initiator_Click);
			// 
			// textBox_mistake
			// 
			this.textBox_mistake.BorderStyle = System.Windows.Forms.BorderStyle.FixedSingle;
			this.textBox_mistake.Location = new System.Drawing.Point(8, 128);
			this.textBox_mistake.MaxLength = 1024;
			this.textBox_mistake.Multiline = true;
			this.textBox_mistake.Name = "textBox_mistake";
			this.textBox_mistake.Size = new System.Drawing.Size(456, 112);
			this.textBox_mistake.TabIndex = 6;
			this.textBox_mistake.Text = "";
			// 
			// button_ok
			// 
			this.button_ok.Location = new System.Drawing.Point(184, 248);
			this.button_ok.Name = "button_ok";
			this.button_ok.TabIndex = 7;
			this.button_ok.Text = "ОК";
			this.button_ok.Click += new System.EventHandler(this.button_ok_Click);
			// 
			// button_remove_mistake_initiator
			// 
			this.button_remove_mistake_initiator.Location = new System.Drawing.Point(440, 88);
			this.button_remove_mistake_initiator.Name = "button_remove_mistake_initiator";
			this.button_remove_mistake_initiator.Size = new System.Drawing.Size(24, 23);
			this.button_remove_mistake_initiator.TabIndex = 8;
			this.button_remove_mistake_initiator.Text = "Х";
			this.button_remove_mistake_initiator.Click += new System.EventHandler(this.button_remove_mistake_initiator_Click);
			// 
			// FormSetMistake
			// 
			this.AutoScaleBaseSize = new System.Drawing.Size(6, 16);
			this.ClientSize = new System.Drawing.Size(474, 277);
			this.Controls.AddRange(new System.Windows.Forms.Control[] {
																		  this.button_remove_mistake_initiator,
																		  this.button_ok,
																		  this.textBox_mistake,
																		  this.button_select_mistake_initiator,
																		  this.textBox_mistake_initiator,
																		  this.label2,
																		  this.label1,
																		  this.button_select_guaranty,
																		  this.textBox_guaranty});
			this.Font = new System.Drawing.Font("Microsoft Sans Serif", 10F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((System.Byte)(204)));
			this.FormBorderStyle = System.Windows.Forms.FormBorderStyle.FixedDialog;
			this.Name = "FormSetMistake";
			this.Text = "Переустановка вида гарантии";
			this.ResumeLayout(false);

		}
		#endregion

		private void button_ok_Click(object sender, System.EventArgs e)
		{
			// Проверка установленных данных
			// Выполняем установку
			mistake_text = textBox_mistake.Text;
			
			switch(the_type)
			{
				case 0:
					if(OkDetail() != true) return;
					break;
				case 1:
					if(OkWork() != true) return;
					break;
				default:
					break;
			}

			this.DialogResult	= DialogResult.OK;
			this.Close();
		}

		private void button_select_guaranty_Click(object sender, System.EventArgs e)
		{
			// Выбираем вид гарантии
			FormGuarantyTypeList dialog = new FormGuarantyTypeList(Db.ClickType.Select);
			if(dialog.ShowDialog() != DialogResult.OK) return;
			guaranty_type	= dialog.GuarantyType;
			textBox_guaranty.Text	= guaranty_type.Description;
		}

		private void button_select_mistake_initiator_Click(object sender, System.EventArgs e)
		{
			// Выбираем виновника
			FormStaffList dialog = new FormStaffList();
			if(dialog.ShowDialog() != DialogResult.OK) return;
			mistake_initiator		= dialog.SelectedStaff;
			textBox_mistake_initiator.Text	= mistake_initiator.Title;
		}

		private void button_remove_mistake_initiator_Click(object sender, System.EventArgs e)
		{
			// Отменяем виновника
			mistake_initiator = null;
			textBox_mistake_initiator.Text = "Не установлен";
		}

		public DtCardDetail CardDetail
		{
			get
			{
				return card_detail;
			}
		}
		public DtCardWork CardWork
		{
			get
			{
				return card_work;
			}
		}

		// Работа с деталями
		private void InitDetail(DtCard card, long position)
		{
			// Получаем элемент с которым работаем
			card_detail = DbSqlCardDetail.Find(card, position);

			// Если деталь не является гарантийной, то ничего делать не можем
			if((bool)card_detail.GetData("ГАРАНТИЯ_КАРТОЧКА_ДЕТАЛЬ") == false)
				button_ok.Enabled = false;

			// Проверяем какие параметры установлены какие нет
			if((long)card_detail.GetData("НАКОСЯЧИЛ_КАРТОЧКА_ДЕТАЛЬ") != 0)
			{
				mistake_initiator = DbStaff.Find((long)card_detail.GetData("НАКОСЯЧИЛ_КАРТОЧКА_ДЕТАЛЬ"));
			}
			if((long)card_detail.GetData("ГАРАНТИЯ_ВИД_КАРТОЧКА_ДЕТАЛЬ") != 0)
			{
				guaranty_type = DbGuarantyType.Find((long)card_detail.GetData("ГАРАНТИЯ_ВИД_КАРТОЧКА_ДЕТАЛЬ"));
			}

			mistake_text		= (string)card_detail.GetData("КОСЯК_КАРТОЧКА_ДЕТАЛЬ");
		}

		private bool OkDetail()
		{
			if(DbSqlCardDetail.UpdateGuaranty(card_detail, guaranty_type, mistake_initiator, mistake_text) != true) return false;

			if(mistake_initiator != null)
			{
				card_detail.SetData("НАКОСЯЧИЛ_КАРТОЧКА_ДЕТАЛЬ", (object)(long)mistake_initiator.Code);
				card_detail.SetData("НАКОСЯЧИЛ_НАИМЕНОВАНИЕ_КАРТОЧКА_ДЕТАЛЬ", (object)(string)(mistake_initiator.FirstName + " " + mistake_initiator.Name + " " + mistake_initiator.SecondName));
			}
			else
			{
				card_detail.SetData("НАКОСЯЧИЛ_КАРТОЧКА_ДЕТАЛЬ", (object)(long)0);
				card_detail.SetData("НАКОСЯЧИЛ_НАИМЕНОВАНИЕ_КАРТОЧКА_ДЕТАЛЬ", (object)(string)"");
			}
			if(guaranty_type != null)
			{
				card_detail.SetData("ГАРАНТИЯ_ВИД_КАРТОЧКА_ДЕТАЛЬ", (object)(long)guaranty_type.Code);
				card_detail.SetData("ГАРАНТИЯ_ВИД_НАИМЕНОВАНИЕ_КАРТОЧКА_ДЕТАЛЬ", (object)(string)guaranty_type.Description);
			}
			else
			{
				card_detail.SetData("ГАРАНТИЯ_ВИД_КАРТОЧКА_ДЕТАЛЬ", (object)(long)0);
				card_detail.SetData("ГАРАНТИЯ_ВИД_НАИМЕНОВАНИЕ_КАРТОЧКА_ДЕТАЛЬ", (object)(string)"");
			}
			card_detail.SetData("КОСЯК_КАРТОЧКА_ДЕТАЛЬ", (object)(string)mistake_text);
			return true;
		}

		// Работа с работами
		private void InitWork(DtCard card, long position)
		{
			// Получаем элемент с которым работаем
			card_work = DbSqlCardWork.Find(card, (int)position);

			// Если деталь не является гарантийной, то ничего делать не можем
			if((bool)card_work.GetData("ГАРАНТИЯ_КАРТОЧКА_РАБОТА") == false)
				button_ok.Enabled = false;

			// Проверяем какие параметры установлены какие нет
			if((long)card_work.GetData("НАКОСЯЧИЛ_КАРТОЧКА_РАБОТА") != 0)
			{
				mistake_initiator = DbStaff.Find((long)card_work.GetData("НАКОСЯЧИЛ_КАРТОЧКА_РАБОТА"));
			}
			if((long)card_work.GetData("ГАРАНТИЯ_ВИД_КАРТОЧКА_РАБОТА") != 0)
			{
				guaranty_type = DbGuarantyType.Find((long)card_work.GetData("ГАРАНТИЯ_ВИД_КАРТОЧКА_РАБОТА"));
			}

			mistake_text		= (string)card_work.GetData("КОСЯК_КАРТОЧКА_РАБОТА");
		}

		private bool OkWork()
		{
			if(DbSqlCardWork.UpdateGuaranty(card_work, guaranty_type, mistake_initiator, mistake_text) != true) return false;

			if(mistake_initiator != null)
			{
				card_work.SetData("НАКОСЯЧИЛ_КАРТОЧКА_РАБОТА", (object)(long)mistake_initiator.Code);
				card_work.SetData("НАКОСЯЧИЛ_НАИМЕНОВАНИЕ_КАРТОЧКА_РАБОТА", (object)(string)(mistake_initiator.FirstName + " " + mistake_initiator.Name + " " + mistake_initiator.SecondName));
			}
			else
			{
				card_work.SetData("НАКОСЯЧИЛ_КАРТОЧКА_РАБОТА", (object)(long)0);
				card_work.SetData("НАКОСЯЧИЛ_НАИМЕНОВАНИЕ_КАРТОЧКА_РАБОТА", (object)(string)"");
			}
			if(guaranty_type != null)
			{
				card_work.SetData("ГАРАНТИЯ_ВИД_КАРТОЧКА_РАБОТА", (object)(long)guaranty_type.Code);
				card_work.SetData("ГАРАНТИЯ_ВИД_НАИМЕНОВАНИЕ_КАРТОЧКА_РАБОТА", (object)(string)guaranty_type.Description);
			}
			else
			{
				card_work.SetData("ГАРАНТИЯ_ВИД_КАРТОЧКА_РАБОТА", (object)(long)0);
				card_work.SetData("ГАРАНТИЯ_ВИД_НАИМЕНОВАНИЕ_КАРТОЧКА_РАБОТА", (object)(string)"");
			}
			card_work.SetData("КОСЯК_КАРТОЧКА_РАБОТА", (object)(string)mistake_text);
			return true;
		}
	}
}
